<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json" />
  <title>×¨×©×™××ª ×§× ×™×•×ª</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    header { background: #111827; color: white; padding: 14px 16px; }
    header h1 { margin: 0; font-size: 18px; }
    header .sub { opacity: 0.8; font-size: 12px; margin-top: 2px; }

    .container { max-width: 980px; margin: 0 auto; padding: 12px; }
    .tabs { display: flex; gap: 8px; margin: 10px 0 12px; flex-wrap: wrap; }
    .tabbtn {
      border: 1px solid #d1d5db; background: white; padding: 10px 12px;
      border-radius: 12px; cursor: pointer; font-weight: 700;
    }
    .tabbtn.active { background: #111827; color: white; border-color: #111827; }

    .card {
      background: white; border: 1px solid #e5e7eb; border-radius: 16px;
      padding: 12px; box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      margin-bottom: 12px;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 160px; }
    label { font-size: 12px; color: #374151; font-weight: 700; display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid #d1d5db; background: white; font-size: 14px;
    }
    textarea { min-height: 80px; resize: vertical; }
    .btnbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      border: 1px solid #d1d5db; background: white; padding: 10px 12px;
      border-radius: 12px; cursor: pointer; font-weight: 800;
    }
    button.primary { background: #111827; color: white; border-color: #111827; }
    button.danger { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
    button.ghost { background: #f9fafb; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .categoryHeader {
      display: flex; align-items: center; gap: 8px; justify-content: space-between;
      padding: 10px 12px; background: #f9fafb; border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .categoryTitle { font-weight: 900; }
    .muted { color: #6b7280; font-size: 12px; }

    .items { margin-top: 10px; display: grid; gap: 8px; }
    .item {
      border: 1px solid #e5e7eb; border-radius: 14px; padding: 10px;
      display: grid; gap: 8px;
    }
    .itemTop { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .itemName { font-weight: 900; flex: 1; min-width: 160px; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; background: #f9fafb; }
    .mini { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .mini input[type="checkbox"] { width: 20px; height: 20px; }
    .qtyWrap { display: flex; gap: 6px; align-items: center; }
    .qtyWrap input { width: 90px; }
    .qtyWrap button { padding: 10px 12px; }
    .bought { opacity: 0.6; text-decoration: line-through; }

    .hr { height: 1px; background: #e5e7eb; margin: 10px 0; }
    .hint { font-size: 12px; color: #374151; line-height: 1.4; }
    .smallActions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .fileRow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .fileRow input[type="file"] { padding: 8px; }
  </style>
</head>
<body>
<header>
  <h1>×¨×©×™××ª ×§× ×™×•×ª</h1>
  <div class="sub">×¤×©×•×˜×”, ×‘×¢×‘×¨×™×ª, ×¢× ×§×˜×’×•×¨×™×•×ª, ×•×©×™×ª×•×£ ×œ×•×•×¦××¤</div>
</header>

<div class="container">
  <div class="tabs">
    <button class="tabbtn active" id="tabShopping">×¨×©×™××ª ×§× ×™×•×ª</button>
    <button class="tabbtn" id="tabCatalog">×§×˜×œ×•×’ ××•×¦×¨×™×</button>
    <button class="tabbtn" id="tabBackup">×’×™×‘×•×™ ×•×©×—×–×•×¨</button>
  </div>

  <section id="viewShopping">
    <div class="card">
      <div class="row">
        <div>
          <label>×›×•×ª×¨×ª ×©×ª×•×¤×™×¢ ×‘×”×•×“×¢×ª ×”×•×•×¦××¤</label>
          <input id="listTitle" placeholder="×œ××©×œ: ×§× ×™×•×ª ×œ×¡×•×¤×¨" />
        </div>
        <div>
          <label>×ª×¦×•×’×”</label>
          <select id="viewMode">
            <option value="all">×”×¦×’ ×”×›×œ (×›×•×œ×œ × ×§× ×”)</option>
            <option value="hideBought">×”×¡×ª×¨ × ×§× ×”</option>
            <option value="onlyNeeded">×¨×§ ××” ×©×¡×™×× ×ª×™ ×©×¦×¨×™×š</option>
          </select>
        </div>
      </div>

     <div class="btnbar">
  <button class="primary" id="btnWhatsApp">×©×œ×— ×œ×•×•×¦××¤</button>
  <button id="btnCopy">×”×¢×ª×§ ×˜×§×¡×˜</button>
  <button id="btnUpdate">×¢×“×›×Ÿ ××¤×œ×™×§×¦×™×”</button>
  <button class="danger" id="btnReset">××¤×¡ ×¨×©×™××ª ×§× ×™×•×ª</button>
</div>


    <div class="card">
      <div class="row">
        <div>
          <label>××•×¦×¨ ×—×“ ×¤×¢××™ (×œ× × ×©××¨ ×‘×§×˜×œ×•×’)</label>
          <input id="oneTimeName" placeholder="×œ××©×œ: × ×™×™×œ×•×Ÿ × ×¦××“ / Batteries AA" />
        </div>
        <div>
          <label>×§×˜×’×•×¨×™×”</label>
          <select id="oneTimeCategory"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>×›××•×ª</label>
          <input id="oneTimeQty" type="number" inputmode="numeric" min="0" value="1" />
        </div>
        <div>
          <label>×”×¢×¨×”</label>
          <input id="oneTimeNote" placeholder="×œ××©×œ: ××•×ª×’ X / ×’×“×•×œ" />
        </div>
        <div style="max-width:240px;">
          <label>&nbsp;</label>
          <button class="primary" id="btnAddOneTime">×”×•×¡×£ ×œ×¨×©×™××”</button>
        </div>
      </div>

      <div class="hint">×”××•×¦×¨ ×™×•×¤×™×¢ ×‘×¨×©×™××” ×•×‘×•×•×¦××¤, ××‘×œ ×œ× ×™×ª×•×•×¡×£ ×œ×§×˜×œ×•×’.</div>
    </div>

    <div id="shoppingContent"></div>
  </section>

  <section id="viewCatalog" style="display:none;">
    <div class="card">
      <div class="row">
        <div>
          <label>×©× ×§×˜×’×•×¨×™×” ×—×“×©×”</label>
          <input id="newCategoryName" placeholder="×œ××©×œ: ×™×¨×§×•×ª" />
        </div>
        <div style="max-width:240px;">
          <label>&nbsp;</label>
          <button class="primary" id="btnAddCategory">×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
        </div>
      </div>
      <div class="hint">×¡×“×¨ ×”×§×˜×’×•×¨×™×•×ª ×§×•×‘×¢ ××ª ×¡×“×¨ ×”×”×¦×’×” ×‘×¨×©×™××ª ×”×§× ×™×•×ª. ××©×ª××©×™× ×‘××¢×œ×”/××˜×” ×›×“×™ ×œ×©× ×•×ª ×¡×“×¨.</div>
    </div>

<div class="card">
  <h3>××—×•×œ×œ ×§×˜×œ×•×’ ××•×˜×•××˜×™</h3>

  <div class="hint">
    ×”×¢×œ×™ ×§×•×‘×¥ Excel ×¢× ×¨×©×™××ª ××•×¦×¨×™× (×¢× ××• ×‘×œ×™ ×§×˜×’×•×¨×™×•×ª).
    ×”××¤×œ×™×§×¦×™×” ×ª× ×¡×” ×œ×–×”×•×ª ×§×˜×’×•×¨×™×•×ª ×œ×‘×“, ×•×ª×¦×™×¢ ×œ×š ×ª×™×§×•× ×™× ×œ×¤× ×™ ×©××™×¨×”.
  </div>

  <div class="row" style="margin-top:10px;">
    <input type="file" id="catalogExcelFile" accept=".xlsx,.xls" />
    <button class="primary" id="btnGenerateCatalog">×¦×•×¨ ×§×˜×œ×•×’ ××§×•×‘×¥</button>
  </div>

  <div class="hint">
    ×”×§×˜×œ×•×’ ×”×§×™×™× ×œ× ×™×™××—×§ â€“ ×™×ª×‘×¦×¢ ××™×–×•×’ ×‘×œ×‘×“.
  </div>
</div>

    
    <div class="card">
      <div class="row">
        <div>
          <label>×©× ××•×¦×¨ ×—×“×© (×¢×‘×¨×™×ª ××• ×× ×’×œ×™×ª)</label>
          <input id="newProductName" placeholder="×œ××©×œ: Milk / ×—×œ×‘" />
        </div>
        <div>
          <label>×§×˜×’×•×¨×™×”</label>
          <select id="newProductCategory"></select>
        </div>
        <div style="max-width:240px;">
          <label>&nbsp;</label>
          <button class="primary" id="btnAddProduct">×”×•×¡×£ ××•×¦×¨</button>
        </div>
      </div>
      <div class="hint">××¤×©×¨ ×œ×›×ª×•×‘ ×’× ×‘×× ×’×œ×™×ª - ×–×” ×™×¢×‘×•×“ ××¦×•×™×Ÿ ×‘×•×•×¦××¤.</div>
    </div>

    <div id="catalogContent"></div>
  </section>

  <section id="viewBackup" style="display:none;">
    <div class="card">
      <div class="hint">
        ×’×™×‘×•×™ ××•××œ×¥ ×œ×¤× ×™ ×”×—×œ×¤×ª ×˜×œ×¤×•×Ÿ. ×”×’×™×‘×•×™ ×›×•×œ×œ ×§×˜×’×•×¨×™×•×ª, ××•×¦×¨×™×, ×”×¡×˜×˜×•×¡ ×©×œ ×”×¨×©×™××”, ×•×’× ××•×¦×¨×™× ×—×“ ×¤×¢××™×™×.
      </div>
      <div class="btnbar">
        <button class="primary" id="btnExport">×”×•×¨×“ ×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
        <button id="btnCopyBackup">×”×¢×ª×§ ×’×™×‘×•×™ ×œ×˜×§×¡×˜</button>
      </div>
      <div class="hr"></div>
      <div class="fileRow">
        <div style="flex:1; min-width: 240px;">
          <label>×©×—×–×•×¨ ××’×™×‘×•×™ (×§×•×‘×¥ JSON)</label>
          <input type="file" id="importFile" accept="application/json" />
        </div>
        <div style="max-width:240px;">
          <label>&nbsp;</label>
          <button class="danger" id="btnImport">×©×—×–×¨ ××”×§×•×‘×¥</button>
        </div>
      </div>
      <div class="hr"></div>
      <label>×’×™×‘×•×™ ×‘×˜×§×¡×˜ (×”×“×‘×§×” ×•×©×—×–×•×¨)</label>
      <textarea id="backupText" placeholder="×›××Ÿ ×™×•×¤×™×¢ JSON. ××¤×©×¨ ×œ×”×¢×ª×™×§, ×œ×©××•×¨ ×‘×•×•××˜×¡××¤/××™×™×œ, ×•×œ×”×“×‘×™×§ ×¤×” ×œ×”×—×–×¨×”."></textarea>
      <div class="btnbar">
        <button id="btnRestoreFromText">×©×—×–×¨ ××”×˜×§×¡×˜</button>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // ×›×œ ×”×§×•×“ ×©×œ×š


 const STORAGE_KEY = "shopping_app_v1";
const CURRENT_SCHEMA_VERSION = 2;


  const DEFAULT_CATEGORIES = [
    "××•×¦×¨×™ ×—×œ×‘",
    "××•×¦×¨×™ × ×™×§×™×•×Ÿ",
    "×›×œ×œ×™",
    "×—×“ ×¤×¢××™",
    "×©×ª×™×”",
    "××ª×•×§×™× ×•×—×˜×™×¤×™×",
    "××¨×˜×™×§×™×",
    "×§×¤×•××™×"
  ];

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function buildDefaultState() {
    const categories = DEFAULT_CATEGORIES.map((name, idx) => ({
      id: uid(),
      name,
      order: idx + 1
    }));
return {
  schemaVersion: CURRENT_SCHEMA_VERSION,
  categories,
  products: [],
  oneTimeProducts: [],
  shopping: {},
  history: [],
  settings: { listTitle: "×§× ×™×•×ª ×œ×¡×•×¤×¨" }
};

  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return buildDefaultState();
    try {
      const parsed = JSON.parse(raw);
      if (!parsed.categories || !Array.isArray(parsed.categories)) return buildDefaultState();
      if (!parsed.products || !Array.isArray(parsed.products)) return buildDefaultState();
      if (!parsed.shopping || typeof parsed.shopping !== "object") parsed.shopping = {};
      if (!parsed.settings || typeof parsed.settings !== "object") parsed.settings = {};
      if (typeof parsed.settings.listTitle !== "string") parsed.settings.listTitle = "×§× ×™×•×ª ×œ×¡×•×¤×¨";
      if (!parsed.oneTimeProducts || !Array.isArray(parsed.oneTimeProducts)) parsed.oneTimeProducts = [];
      return parsed;
    } catch {
      return buildDefaultState();
    }
  }

  let state = loadState();

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  const el = (id) => document.getElementById(id);

  function setActiveTab(tabName) {
    const tabs = [
      { btn: el("tabShopping"), view: el("viewShopping"), name: "shopping" },
      { btn: el("tabCatalog"), view: el("viewCatalog"), name: "catalog" },
      { btn: el("tabBackup"), view: el("viewBackup"), name: "backup" }
    ];
    tabs.forEach(t => {
      const active = t.name === tabName;
      t.btn.classList.toggle("active", active);
      t.view.style.display = active ? "" : "none";
    });
  }

  el("tabShopping").addEventListener("click", () => setActiveTab("shopping"));
  el("tabCatalog").addEventListener("click", () => setActiveTab("catalog"));
  el("tabBackup").addEventListener("click", () => setActiveTab("backup"));

  function sortedCategories() {
    return [...state.categories].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
  }

  function getCategoryById(id) {
    return state.categories.find(c => c.id === id);
  }

  function updateCategoryDropdown() {
    const sel = el("newProductCategory");
    sel.innerHTML = "";
    sortedCategories().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
  }

  function updateOneTimeCategoryDropdown() {
    const sel = el("oneTimeCategory");
    if (!sel) return;
    sel.innerHTML = "";
    sortedCategories().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
  }

  el("btnAddCategory").addEventListener("click", () => {
    const name = el("newCategoryName").value.trim();
    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×§×˜×’×•×¨×™×”.");
    const maxOrder = Math.max(0, ...state.categories.map(c => c.order || 0));
    state.categories.push({ id: uid(), name, order: maxOrder + 1 });
    el("newCategoryName").value = "";
    saveState();
    renderAll();
  });

  function moveCategory(catId, dir) {
    const cats = sortedCategories();
    const idx = cats.findIndex(c => c.id === catId);
    const swapWith = idx + dir;
    if (idx < 0 || swapWith < 0 || swapWith >= cats.length) return;

    const a = cats[idx];
    const b = cats[swapWith];
    const tmp = a.order;
    a.order = b.order;
    b.order = tmp;

    state.categories = state.categories.map(c => {
      if (c.id === a.id) return a;
      if (c.id === b.id) return b;
      return c;
    });

    saveState();
    renderAll();
  }

  function renameCategory(catId) {
    const cat = getCategoryById(catId);
    if (!cat) return;
    const name = prompt("×©× ×—×“×© ×œ×§×˜×’×•×¨×™×”:", cat.name);
    if (name === null) return;
    const trimmed = name.trim();
    if (!trimmed) return alert("×©× ×§×˜×’×•×¨×™×” ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§.");
    cat.name = trimmed;
    saveState();
    renderAll();
  }

  function deleteCategory(catId) {
    const cat = getCategoryById(catId);
    if (!cat) return;
    const productsInCat = state.products.filter(p => p.categoryId === catId);
    const oneTimesInCat = state.oneTimeProducts.filter(p => p.categoryId === catId);
    const total = productsInCat.length + oneTimesInCat.length;

    const msg = total
      ? `×‘×§×˜×’×•×¨×™×” ×”×–×• ×™×© ${total} ×¤×¨×™×˜×™× (×›×•×œ×œ ×—×“ ×¤×¢××™×™×). ×œ××—×•×§?`
      : "×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×”?";

    if (!confirm(msg)) return;

    const prodIds = new Set(productsInCat.map(p => p.id));
    const oneTimeIds = new Set(oneTimesInCat.map(p => p.id));

    state.products = state.products.filter(p => p.categoryId !== catId);
    state.oneTimeProducts = state.oneTimeProducts.filter(p => p.categoryId !== catId);

    for (const pid of prodIds) delete state.shopping[pid];
    for (const oid of oneTimeIds) delete state.shopping[oid];

    state.categories = state.categories.filter(c => c.id !== catId);
    saveState();
    renderAll();
  }

  function productsByCategory(catId) {
    return state.products
      .filter(p => p.categoryId === catId)
      .sort((a, b) => a.name.localeCompare(b.name, "he"));
  }

  el("btnAddProduct").addEventListener("click", () => {
    const name = el("newProductName").value.trim();
    const categoryId = el("newProductCategory").value;
    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ××•×¦×¨.");
    if (!categoryId) return alert("× × ×œ×‘×—×•×¨ ×§×˜×’×•×¨×™×”.");
    state.products.push({ id: uid(), name, categoryId });
    el("newProductName").value = "";
    saveState();
    renderAll();
  });

  function renameProduct(prodId) {
    const p = state.products.find(x => x.id === prodId);
    if (!p) return;
    const name = prompt("×©× ×—×“×© ×œ××•×¦×¨:", p.name);
    if (name === null) return;
    const trimmed = name.trim();
    if (!trimmed) return alert("×©× ××•×¦×¨ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§.");
    p.name = trimmed;
    saveState();
    renderAll();
  }

  function moveProductCategory(prodId) {
    const p = state.products.find(x => x.id === prodId);
    if (!p) return;
    const options = sortedCategories().map(c => `${c.name}`).join("\n");
    const newName = prompt("×œ××™×–×” ×§×˜×’×•×¨×™×” ×œ×”×¢×‘×™×¨? ×›×ª×‘×™ ×‘×“×™×•×§ ××ª ×”×©× ××”×¨×©×™××”:\n\n" + options, getCategoryById(p.categoryId)?.name || "");
    if (newName === null) return;
    const match = state.categories.find(c => c.name === newName.trim());
    if (!match) return alert("×œ× × ××¦××” ×§×˜×’×•×¨×™×” ×‘×©× ×”×–×”. × ×¡×™ ×©×•×‘.");
    p.categoryId = match.id;
    saveState();
    renderAll();
  }

  function deleteProduct(prodId) {
    const p = state.products.find(x => x.id === prodId);
    if (!p) return;
    if (!confirm(`×œ××—×•×§ ××ª ×”××•×¦×¨: ${p.name}?`)) return;
    state.products = state.products.filter(x => x.id !== prodId);
    delete state.shopping[prodId];
    saveState();
    renderAll();
  }

  function getShopItem(prodId) {
    if (!state.shopping[prodId]) {
      state.shopping[prodId] = { needed: false, qty: 1, note: "", bought: false };
    }
    return state.shopping[prodId];
  }

  function resetShoppingList() {
    if (!confirm("×œ××¤×¡ ××ª ×”×¨×©×™××”? ×–×” ×™× ×§×” ××ª ×”×¡×™××•× ×™×, ×”×›××•×™×•×ª ×•×”×”×¢×¨×•×ª, ×•×’× ×™××—×§ ××•×¦×¨×™× ×—×“ ×¤×¢××™×™×.")) return;
    state.shopping = {};
    state.oneTimeProducts = [];
    saveState();
    renderAll();
  }

  el("btnReset").addEventListener("click", resetShoppingList);

  function addOneTimeProduct() {
    const name = el("oneTimeName").value.trim();
    const categoryId = el("oneTimeCategory").value;
    const qty = Number(el("oneTimeQty").value);
    const note = el("oneTimeNote").value || "";

    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ××•×¦×¨ ×—×“ ×¤×¢××™.");
    if (!categoryId) return alert("× × ×œ×‘×—×•×¨ ×§×˜×’×•×¨×™×”.");

    const id = uid();
    state.oneTimeProducts.push({ id, name, categoryId });

    state.shopping[id] = {
      needed: true,
      qty: Number.isFinite(qty) ? qty : 1,
      note: note,
      bought: false
    };

    el("oneTimeName").value = "";
    el("oneTimeQty").value = "1";
    el("oneTimeNote").value = "";

    saveState();
    renderAll();
  }

  el("btnAddOneTime").addEventListener("click", addOneTimeProduct);

  function deleteOneTimeProduct(oneTimeId) {
    const p = state.oneTimeProducts.find(x => x.id === oneTimeId);
    if (!p) return;
    if (!confirm(`×œ××—×•×§ ××•×¦×¨ ×—×“ ×¤×¢××™: ${p.name}?`)) return;

    state.oneTimeProducts = state.oneTimeProducts.filter(x => x.id !== oneTimeId);
    delete state.shopping[oneTimeId];

    saveState();
    renderAll();
  }

function buildShareText() {
  const title = state.settings.listTitle || "×¨×©×™××ª ×§× ×™×•×ª";

  let lines = [`*${title}*`, ""];

  sortedCategories().forEach(cat => {
    const items = [];

    for (const productId in state.shopping) {
      const s = state.shopping[productId];

      if (!s.needed || s.bought) continue;

      const product = state.products.find(p => p.id === productId) ||
                      state.oneTimeProducts.find(p => p.id === productId);

      if (!product || product.categoryId !== cat.id) continue;

      const qty = s.qty || 1;
      const notePart = s.note ? ` (${s.note})` : "";

      items.push(`â€¢ ${qty} ${product.name}${notePart}`);
    }

    if (items.length) {
      lines.push(`*${cat.name}*`);
      lines.push(...items);
      lines.push("");
    }
  });

  return lines.join("\n");
}


  function openWhatsApp(text) {
    const encoded = encodeURIComponent(text);
    const url = `https://wa.me/?text=${encoded}`;
    window.open(url, "_blank");
  }

  el("btnWhatsApp").addEventListener("click", () => {
    const text = buildShareText();
    openWhatsApp(text);
    el("shareHint").textContent = "× ×¤×ª×— ×—×œ×•×Ÿ ×©×™×ª×•×£ ×œ×•×•×¦××¤. ×× ×œ× × ×¤×ª×— - ×”×©×ª××©×™ ×‘×›×¤×ª×•×¨ '×”×¢×ª×§ ×˜×§×¡×˜' ×•×”×“×‘×™×§×™ ×‘×•×•×¦××¤.";
  });

  el("btnCopy").addEventListener("click", async () => {
    const text = buildShareText();
    try {
      await navigator.clipboard.writeText(text);
      el("shareHint").textContent = "×”×˜×§×¡×˜ ×”×•×¢×ª×§. ××¤×©×¨ ×œ×”×“×‘×™×§ ×‘×•×•×¦××¤.";
    } catch {
      el("shareHint").textContent = "×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª. ××•×¤×™×¢ ×—×œ×•×Ÿ ×¢× ×”×˜×§×¡×˜ - ×”×¢×ª×™×§×™ ×™×“× ×™×ª.";
      alert(text);
    }
  });

  function download(filename, content) {
    const blob = new Blob([content], { type: "application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  el("btnExport").addEventListener("click", () => {
    const payload = JSON.stringify(state, null, 2);
    const stamp = new Date().toISOString().slice(0, 10);
    download(`shopping-backup-${stamp}.json`, payload);
    el("backupText").value = payload;
  });

  el("btnCopyBackup").addEventListener("click", async () => {
    const payload = JSON.stringify(state);
    el("backupText").value = payload;
    try {
      await navigator.clipboard.writeText(payload);
      alert("×’×™×‘×•×™ ×”×•×¢×ª×§ ×œ×œ×•×—.");
    } catch {
      alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª. ××¤×©×¨ ×œ×”×¢×ª×™×§ ×™×“× ×™×ª ××”×©×“×”.");
    }
  });

  el("btnImport").addEventListener("click", async () => {
    const file = el("importFile").files?.[0];
    if (!file) return alert("× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×’×™×‘×•×™.");
    if (!confirm("×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×. ×œ×”××©×™×š?")) return;
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      state = parsed;
      if (!state.oneTimeProducts || !Array.isArray(state.oneTimeProducts)) state.oneTimeProducts = [];
      saveState();
      renderAll();
      alert("×©×—×–×•×¨ ×”×•×©×œ×.");
    } catch {
      alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ ××• ×©×’×™××” ×‘×§×¨×™××”.");
    }
  });

  el("btnRestoreFromText").addEventListener("click", () => {
    const raw = el("backupText").value.trim();
    if (!raw) return alert("× × ×œ×”×“×‘×™×§ ×˜×§×¡×˜ ×’×™×‘×•×™.");
    if (!confirm("×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×. ×œ×”××©×™×š?")) return;
    try {
      const parsed = JSON.parse(raw);
      state = parsed;
      if (!state.oneTimeProducts || !Array.isArray(state.oneTimeProducts)) state.oneTimeProducts = [];
      saveState();
      renderAll();
      alert("×©×—×–×•×¨ ×”×•×©×œ×.");
    } catch {
      alert("×˜×§×¡×˜ ×œ× ×ª×§×™×Ÿ (JSON).");
    }
  });

  function renderShopping() {
    updateOneTimeCategoryDropdown();

    el("listTitle").value = state.settings.listTitle || "×§× ×™×•×ª ×œ×¡×•×¤×¨";

    el("listTitle").addEventListener("input", () => {
      state.settings.listTitle = el("listTitle").value;
      saveState();
    });

    const container = el("shoppingContent");
    container.innerHTML = "";

    const cats = sortedCategories();
    if (!cats.length) {
      container.innerHTML = `<div class="card">××™×Ÿ ×§×˜×’×•×¨×™×•×ª. ×”×•×¡×™×¤×™ ×§×˜×’×•×¨×™×•×ª ×‘×§×˜×œ×•×’.</div>`;
      return;
    }

    for (const c of cats) {
      const prods = productsByCategory(c.id);
      const oneTimes = state.oneTimeProducts
        .filter(p => p.categoryId === c.id)
        .sort((a, b) => a.name.localeCompare(b.name, "he"));

      const card = document.createElement("div");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "categoryHeader";
      header.innerHTML = `
        <div class="categoryTitle">${escapeHtml(c.name)}</div>
        <div class="muted">${prods.length + oneTimes.length} ××•×¦×¨×™×</div>
      `;
      card.appendChild(header);

      const items = document.createElement("div");
      items.className = "items";

      const allItems = [
        ...prods.map(p => ({ ...p, isOneTime: false })),
        ...oneTimes.map(p => ({ ...p, isOneTime: true }))
      ];

      for (const p of allItems) {
        const s = state.shopping[p.id];
        const mode = el("viewMode").value;

        const isNeeded = !!(s && s.needed);
        const isBought = !!(s && s.bought);

        if (mode === "onlyNeeded" && !isNeeded) continue;
        if (mode === "hideBought" && isBought && isNeeded) continue;

        const item = document.createElement("div");
        item.className = "item";

        const shop = getShopItem(p.id);

        const top = document.createElement("div");
        top.className = "itemTop";

        const name = document.createElement("div");
        name.className = "itemName" + (shop.bought ? " bought" : "");
        name.textContent = p.name + (p.isOneTime ? " (×—×“ ×¤×¢××™)" : "");

        const neededWrap = document.createElement("div");
        neededWrap.className = "mini";
        const needed = document.createElement("input");
        needed.type = "checkbox";
        needed.checked = !!shop.needed;
        needed.addEventListener("change", () => {
          shop.needed = needed.checked;
          saveState();
          renderShopping();
        });
        const neededLbl = document.createElement("span");
        neededLbl.className = "pill";
        neededLbl.textContent = "×¦×¨×™×š";
        neededWrap.appendChild(needed);
        neededWrap.appendChild(neededLbl);

        const boughtWrap = document.createElement("div");
        boughtWrap.className = "mini";
        const bought = document.createElement("input");
        bought.type = "checkbox";
        bought.checked = !!shop.bought;
        bought.disabled = !shop.needed;
        bought.addEventListener("change", () => {
          shop.bought = bought.checked;
          saveState();
          renderShopping();
        });
        const boughtLbl = document.createElement("span");
        boughtLbl.className = "pill";
        boughtLbl.textContent = "× ×§× ×”";
        boughtWrap.appendChild(bought);
        boughtWrap.appendChild(boughtLbl);

        top.appendChild(name);
        top.appendChild(neededWrap);
        top.appendChild(boughtWrap);

        if (p.isOneTime) {
          const del = document.createElement("button");
          del.className = "danger";
          del.textContent = "××—×§";
          del.addEventListener("click", () => deleteOneTimeProduct(p.id));
          top.appendChild(del);
        }

        const bottom = document.createElement("div");
        bottom.className = "row";

        const qtyBox = document.createElement("div");
        qtyBox.innerHTML = `<label>×›××•×ª</label>`;
        const qtyWrap = document.createElement("div");
        qtyWrap.className = "qtyWrap";
        const btnMinus = document.createElement("button");
        btnMinus.className = "ghost";
        btnMinus.textContent = "-";
        btnMinus.disabled = !shop.needed;
        btnMinus.addEventListener("click", () => {
          shop.qty = Math.max(0, (Number(shop.qty) || 0) - 1);
          saveState();
          renderShopping();
        });

        const qty = document.createElement("input");
        qty.type = "number";
        qty.inputMode = "numeric";
        qty.min = "0";
        qty.value = String(Number(shop.qty) || 0);
        qty.disabled = !shop.needed;
        qty.addEventListener("input", () => {
          const v = Number(qty.value);
          shop.qty = Number.isFinite(v) ? v : 0;
          saveState();
        });

        const btnPlus = document.createElement("button");
        btnPlus.className = "ghost";
        btnPlus.textContent = "+";
        btnPlus.disabled = !shop.needed;
        btnPlus.addEventListener("click", () => {
          shop.qty = (Number(shop.qty) || 0) + 1;
          saveState();
          renderShopping();
        });

        qtyWrap.appendChild(btnMinus);
        qtyWrap.appendChild(qty);
        qtyWrap.appendChild(btnPlus);
        qtyBox.appendChild(qtyWrap);

        const noteBox = document.createElement("div");
        noteBox.innerHTML = `<label>×”×¢×¨×”</label>`;
        const note = document.createElement("input");
        note.placeholder = "×œ××©×œ: ×œ×œ× ×¡×•×›×¨ / ×’×“×•×œ / ××•×ª×’ ××¡×•×™×";
        note.value = shop.note || "";
        note.disabled = !shop.needed;
        note.addEventListener("input", () => {
          shop.note = note.value;
          saveState();
        });
        noteBox.appendChild(note);

        bottom.appendChild(qtyBox);
        bottom.appendChild(noteBox);

        item.appendChild(top);
        item.appendChild(bottom);
        items.appendChild(item);
      }

      if (!items.children.length) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "××™×Ÿ ××•×¦×¨×™× ×œ×”×¦×’×” ×‘×§×˜×’×•×¨×™×” ×”×–×• (×‘××¦×‘ ×”×ª×¦×•×’×” ×”× ×•×›×—×™).";
        card.appendChild(empty);
      } else {
        card.appendChild(items);
      }

      container.appendChild(card);
    }
  }

  function renderCatalog() {
    updateCategoryDropdown();
    updateOneTimeCategoryDropdown();

    const container = el("catalogContent");
    container.innerHTML = "";

    const cats = sortedCategories();
    for (const c of cats) {
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "categoryHeader";

      const left = document.createElement("div");
      left.innerHTML = `<div class="categoryTitle">${escapeHtml(c.name)}</div><div class="muted">×¡×“×¨: ${c.order}</div>`;

      const actions = document.createElement("div");
      actions.className = "smallActions";

      const up = document.createElement("button");
      up.textContent = "××¢×œ×”";
      up.addEventListener("click", () => moveCategory(c.id, -1));

      const down = document.createElement("button");
      down.textContent = "××˜×”";
      down.addEventListener("click", () => moveCategory(c.id, +1));

      const rename = document.createElement("button");
      rename.textContent = "×¢×¨×•×š ×©×";
      rename.addEventListener("click", () => renameCategory(c.id));

      const del = document.createElement("button");
      del.className = "danger";
      del.textContent = "××—×§";
      del.addEventListener("click", () => deleteCategory(c.id));

      actions.appendChild(up);
      actions.appendChild(down);
      actions.appendChild(rename);
      actions.appendChild(del);

      head.appendChild(left);
      head.appendChild(actions);
      card.appendChild(head);

      const prods = productsByCategory(c.id);
      const items = document.createElement("div");
      items.className = "items";

      for (const p of prods) {
        const item = document.createElement("div");
        item.className = "item";

        const top = document.createElement("div");
        top.className = "itemTop";

        const name = document.createElement("div");
        name.className = "itemName";
        name.textContent = p.name;

        const acts = document.createElement("div");
        acts.className = "smallActions";

        const btnRename = document.createElement("button");
        btnRename.textContent = "×¢×¨×•×š";
        btnRename.addEventListener("click", () => renameProduct(p.id));

        const btnMove = document.createElement("button");
        btnMove.textContent = "×”×¢×‘×¨ ×§×˜×’×•×¨×™×”";
        btnMove.addEventListener("click", () => moveProductCategory(p.id));

        const btnDel = document.createElement("button");
        btnDel.className = "danger";
        btnDel.textContent = "××—×§";
        btnDel.addEventListener("click", () => deleteProduct(p.id));

        acts.appendChild(btnRename);
        acts.appendChild(btnMove);
        acts.appendChild(btnDel);

        top.appendChild(name);
        top.appendChild(acts);

        item.appendChild(top);
        items.appendChild(item);
      }

      if (!items.children.length) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "××™×Ÿ ××•×¦×¨×™× ×‘×§×˜×’×•×¨×™×” ×”×–×• ×¢×“×™×™×Ÿ.";
        card.appendChild(empty);
      } else {
        card.appendChild(items);
      }

      container.appendChild(card);
    }
  }

  function renderBackup() {
    el("backupText").value = "";
  }

  function renderAll() {
    renderShopping();
    renderCatalog();
    renderBackup();
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  el("viewMode").addEventListener("change", renderShopping);
// ================================
// ××—×•×œ×œ ×§×˜×œ×•×’ â€“ ×©×œ×‘ 1: ×§×¨×™××ª Excel (×‘×“×™×§×”)
// ================================
const btnGenerate = el("btnGenerateCatalog");
if (btnGenerate) {
  btnGenerate.addEventListener("click", async () => {
    const fileInput = el("catalogExcelFile");
    const file = fileInput?.files?.[0];

    if (!file) {
      alert("× × ×œ×‘×—×•×¨ ×§×•×‘×¥ Excel ×§×•×“×");
      return;
    }

    try {
      const buffer = await file.arrayBuffer();
      const workbook = XLSX.read(buffer, { type: "array" });

      console.log("ğŸ“˜ Sheet names:", workbook.SheetNames);

      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];

      const rows = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        raw: true
      });

      console.log("ğŸ“„ Using sheet:", sheetName);
      console.log("ğŸ“Š Rows count:", rows.length);
      console.log("ğŸ§¾ Preview (first 30 rows):");
      console.table(rows.slice(0, 30));

      alert("×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”. ×¤×ª×—×™ Console ×œ×¨××•×ª × ×ª×•× ×™×.");
    } catch (err) {
      console.error("âŒ Excel read error:", err);
      alert("×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. ×‘×“×§×™ Console.");
    }
  });
}

  renderAll();

 if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then((reg) => {
    // ×›×¤×ª×•×¨ ×¢×“×›×•×Ÿ ×™×“× ×™
    const btnUpdate = el("btnUpdate");
    if (btnUpdate) {
      btnUpdate.addEventListener("click", async () => {
        try {
          await reg.update(); // ×‘×“×™×§×” ×œ××©×™×›×ª ×’×¨×¡×” ×—×“×©×”
          if (reg.waiting) {
            reg.waiting.postMessage({ type: "SKIP_WAITING" });
          }
          // ×¨×¢× ×•×Ÿ ×›×“×™ ×œ×”×™×›× ×¡ ×œ×’×¨×¡×” ×”×—×“×©×”
          location.reload();
        } catch {
          alert("×œ× ×”×¦×œ×—×ª×™ ×œ×¢×“×›×Ÿ ×›×¨×’×¢. × ×¡×™ ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.");
        }
      });
    }

    // ×× ×™×© worker ×—×“×© ×©×××ª×™×Ÿ - × ×¢×“×›×Ÿ ××™×“
    reg.addEventListener("updatefound", () => {
      const newWorker = reg.installing;
      if (!newWorker) return;
      newWorker.addEventListener("statechange", () => {
        if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
          // ×™×© ×¢×“×›×•×Ÿ ××•×›×Ÿ
          el("shareHint").textContent = "×™×© ×¢×“×›×•×Ÿ ×œ××¤×œ×™×§×¦×™×”. ×œ×—×¦×™ ×¢×œ '×¢×“×›×Ÿ ××¤×œ×™×§×¦×™×”'.";
        }
      });
    });
  }).catch(() => {});
}



</script>
</body>
</html>











